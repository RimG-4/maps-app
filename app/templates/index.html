<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –£—Ñ—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .control-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 320px;
        font-family: Arial, sans-serif;
    }

    .control-panel h3 {
        margin: 0 0 10px;
        font-size: 18px;
        text-align: center;
        color: #333;
    }

    .control-panel input {
        width: calc(100% - 20px);
        margin: 5px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .control-panel input:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    .control-panel button {
        width: 100%;
        padding: 12px;
        margin-top:
    }

    .custom-marker {
         background-color: red;
         color: white;
         text-align: center;
         font-weight: bold;
         border-radius: 50%;
         width: 24px;
         height: 24px;
         line-height: 24px;
         }


    input { width: 100%; margin: 5px 0; padding: 8px; }
    button { width: 100%; padding: 10px; margin-top: 5px; }

    .user-marker {
         font-size: 24px;
         animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
         0% { transform: scale(1); }
         50% { transform: scale(1.2); }
         100% { transform: scale(1); }
    }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="control-panel">
        <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞">
        <input type="text" id="to" placeholder="–ö—É–¥–∞">
        <button onclick="buildRoute()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        <p id="route-info" style="font-size: 14px; color: #333; margin-top: 10px;"></p>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function requestGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    showUserPosition,
                    handleGeolocationError,
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
            }
        }

        // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function showUserPosition(position) {
            const userCoords = [position.coords.latitude, position.coords.longitude];

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø—Ä–∏–º–µ—Ä –¥–ª—è –≤–∞—à–µ–≥–æ AuthService)
            fetch('/update-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    coords: userCoords,
                    accuracy: position.coords.accuracy
                })
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ (–ø—Ä–∏–º–µ—Ä –¥–ª—è –≤–∞—à–µ–≥–æ MapRenderer)
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userCoords, {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: 'üìç',
                    iconSize: [30, 30]
                })
            }).addTo(map);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        function handleGeolocationError(error) {
            let message = "";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
                    break;
                case error.TIMEOUT:
                    message = "–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ";
                    break;
            }
            alert("–û—à–∏–±–∫–∞: " + message);
        }

        // –ö–Ω–æ–ø–∫–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–¥–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à control-panel)
        <button onclick="requestGeolocation()" id="locate-btn">–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>

        function startNavigation() {
            watchId = navigator.geolocation.watchPosition(
                position => {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
                    map.panTo([position.coords.latitude, position.coords.longitude]);

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NavigationSystem)
                    if (navigationSystem.checkDeviation(position.coords)) {
                        alert("–í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏—Å—å –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞!");
                    }
                },
                null,
                { enableHighAccuracy: true }
        );
}
        function buildRoute() {
            let from = document.getElementById('from').value;
            let to = document.getElementById('to').value;
            let infoPanel = document.getElementById('route-info');

            if (!from || !to) {
                alert("–í–≤–µ–¥–∏—Ç–µ –æ–±–∞ –∞–¥—Ä–µ—Å–∞");
                return;
            }

            // –û—á–∏—â–∞–µ–º –ø—Ä–æ—à–ª—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (routeLayer) map.removeLayer(routeLayer);
            if (fromMarker) map.removeLayer(fromMarker);
            if (toMarker) map.removeLayer(toMarker);

            infoPanel.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
            infoPanel.innerHTML = "‚è≥ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç...";

            fetch(`/route?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        infoPanel.style.display = "none";
                        return;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å—Ä–∞–∑—É
                    fromMarker = L.marker(data.from_point, { icon: L.divIcon({className: 'marker-A', html: 'üÖ∞Ô∏è', iconSize: [20, 20]}) }).addTo(map);
                    toMarker = L.marker(data.to_point, { icon: L.divIcon({className: 'marker-B', html: 'üÖ±Ô∏è', iconSize: [20, 20]}) }).addTo(map);

                    // –†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç
                    routeLayer = L.polyline(data.route, {
                        color: 'blue',
                        weight: 5,
                        opacity: 0.7
                    }).addTo(map);

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
                    map.fitBounds(routeLayer.getBounds());

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    infoPanel.innerHTML = `üöó ${data.distance} <br> ‚è≥ ${data.travel_time}`;
                    infoPanel.style.display = "block";
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞");
                    infoPanel.style.display = "none";
                });
        }


    </script>
</body>
</html>